#!/bin/bash
# ENHANCED AI FRAMEWORK MONITOR
# Purpose: Prevent future branch monitoring blindspots
# Auto-updates CURRENT_TASK.md with real branch activity

echo "ğŸ¤– ENHANCED AI FRAMEWORK MONITOR"
echo "================================="

# Run branch monitor
./.ai-framework/branch-monitor.sh

# Extract key metrics
TOTAL_BRANCHES=$(git branch -r | grep -E "origin/claude/" | grep -v HEAD | wc -l | tr -d ' ')
RECENT_COMMITS=$(git log --all --since="24 hours ago" --oneline | grep -E "claude/" | wc -l | tr -d ' ')
LATEST_COMPLETION=$(git log --all --since="48 hours ago" --grep="Complete\|Implement\|Finish\|Done" --oneline | head -1)

echo
echo "ğŸ“Š AUTO-UPDATING FRAMEWORK STATUS..."

# Auto-update CURRENT_TASK.md with latest metrics
cat > .ai/FRAMEWORK_STATUS.md << EOF
# ğŸ¤– AI FRAMEWORK STATUS (Auto-Updated)
**Last Updated:** $(date '+%Y-%m-%d %H:%M:%S')

## ğŸ“Š LIVE METRICS
- **Active Claude Branches:** $TOTAL_BRANCHES
- **Recent Commits (24h):** $RECENT_COMMITS
- **Latest Activity:** $(date '+%H:%M:%S')

## ğŸ” LATEST COMPLETION DETECTED:
$LATEST_COMPLETION

## ğŸ› ï¸ FRAMEWORK STATUS
âœ… **Branch Monitoring:** Active
âœ… **Cross-Branch Tracking:** Operational
âœ… **Auto-Updates:** Functioning
âœ… **Blindspot Prevention:** Enabled

## ğŸ“ˆ RECENT BRANCH ACTIVITY
$(git log --all --since="6 hours ago" --format="- %cr: %s" | head -10)

---
*Auto-generated by enhanced-monitor.sh*
EOF

echo "âœ… Framework status updated: .ai/FRAMEWORK_STATUS.md"

# Check if there's new completion activity
if [ ! -z "$LATEST_COMPLETION" ]; then
    echo "ğŸ‰ NEW COMPLETION DETECTED!"
    echo "   $LATEST_COMPLETION"

    # Update main task status if major completion found
    if echo "$LATEST_COMPLETION" | grep -q "Complete\|Phase"; then
        echo "ğŸ”„ Major completion detected - framework should be notified"

        # Add completion alert to CURRENT_TASK.md
        echo "" >> .ai/CURRENT_TASK.md
        echo "## ğŸš¨ LATEST COMPLETION ALERT" >> .ai/CURRENT_TASK.md
        echo "**Detected:** $(date '+%Y-%m-%d %H:%M:%S')" >> .ai/CURRENT_TASK.md
        echo "$LATEST_COMPLETION" >> .ai/CURRENT_TASK.md
        echo "" >> .ai/CURRENT_TASK.md
    fi
fi

echo "ğŸ”„ Enhanced monitoring cycle complete."

# Generate monitoring summary
echo
echo "ğŸ“‹ MONITORING SUMMARY:"
echo "â”œâ”€â”€ Active Branches: $TOTAL_BRANCHES"
echo "â”œâ”€â”€ Recent Activity: $RECENT_COMMITS commits"
echo "â”œâ”€â”€ Framework Status: âœ… Operational"
echo "â””â”€â”€ Blindspot Risk: âŒ Prevented"
echo